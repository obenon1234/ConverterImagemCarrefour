<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas Carrefour: OCR, Limpador de CÃ³digo de Barras, Juntar PDF e Validador</title>
    <!-- Adicionado para o Validador de Pagamento -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Estilos Originais */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0050A4; /* Azul do Carrefour */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .tab-container {
            max-width: 1200px;
            width: 100%;
            background: #FFFFFF;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #333333;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap; 
        }

        .tab-button {
            background: #D0D0D0;
            color: #333333;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tab-button:hover {
            background: #C0C0C0;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .tab-button.active {
            background: linear-gradient(45deg, #ED1C24, #C00000);
            color: white;
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            color: #333333;
        }

        .paste-area, .barcode-input-section {
            background: #E0E0E0;
            border: 3px dashed rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            color: #333333;
        }

        .paste-area:hover, .barcode-input-section:hover {
            border-color: rgba(0, 0, 0, 0.6);
            background: #D0D0D0;
            transform: translateY(-2px);
        }

        .paste-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
            color: #333333;
        }

        .paste-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .paste-hint {
            opacity: 0.8;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }

        .upload-btn, .barcode-clean-btn, .join-pdf-btn {
            background: linear-gradient(45deg, #ED1C24, #C00000);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover, .barcode-clean-btn:hover, .join-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .ocr-btn {
            background: linear-gradient(45deg, #ED1C24, #C00000);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 20px 0;
            transition: all 0.3s ease;
            width: 100%;
        }

        .ocr-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .ocr-btn:disabled, .barcode-clean-btn:disabled, .join-pdf-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .image-preview, .text-output, .barcode-output, .pdf-output-area {
            background: #E0E0E0;
            border-radius: 15px;
            padding: 20px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            color: #333333;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333333;
        }

        .preview-img {
            max-width: 100%;
            max-height: 250px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            object-fit: contain;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .text-result, .barcode-result-text {
            background: #CCCCCC;
            border-radius: 10px;
            padding: 15px;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            white-space: pre-wrap; /* Changed from nowrap */
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid rgba(0, 0, 0, 0.2);
            flex-grow: 1;
            color: #333333;
        }

        .copy-btn {
            background: linear-gradient(45deg, #ED1C24, #C00000);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .copy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .file-input {
            display: none;
        }

        .language-selector {
            margin: 15px 0;
            display: none; 
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .lang-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lang-btn.active {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            border-color: #FF9800;
        }

        .barcode-input-section textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            margin-top: 15px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 30px 20px;
            background: #E0E0E0;
            border-radius: 15px;
            margin-bottom: 30px;
            color: #333333;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top: 3px solid #333333;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            color: rgba(51, 51, 51, 0.6);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .error-state {
            color: #D32F2F;
            text-align: center;
            padding: 10px;
        }

        .success-state {
            color: #388E3C;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .warning-state {
            color: #FBC02D;
            margin-bottom: 15px;
        }

        .usage-info {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.8rem;
            color: #333333;
        }

        .character-count-info {
            font-size: 0.85rem;
            margin-top: 10px;
            opacity: 0.8;
            color: rgba(51, 51, 51, 0.7);
            text-align: right;
        }

        .footer {
            margin-top: 40px;
            text-align: center;
            color: white;
            font-size: 0.75rem;
            padding: 10px 20px;
            background-color: #0050A4;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .footer-left, .footer-center, .footer-right {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .footer-left {
            text-align: left;
        }

        .footer-right {
            text-align: right;
        }

        .pdf-input-area {
            background: #E0E0E0;
            border: 3px dashed rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            color: #333333;
        }

        .pdf-input-area:hover {
            border-color: rgba(0, 0, 0, 0.6);
            background: #D0D0D0;
        }

        .pdf-file-list {
            list-style: none;
            padding: 0;
            max-height: 150px;
            overflow-y: auto;
            margin-top: 20px;
            text-align: left;
            border-top: 1px solid #ccc;
            padding-top: 10px;
        }

        .pdf-file-list li {
            background: #F0F0F0;
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #333;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .pdf-file-list li .remove-file-btn {
            background: none;
            border: none;
            color: #ED1C24;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0 5px;
            transition: color 0.2s ease;
        }

        .pdf-file-list li .remove-file-btn:hover {
            color: #C00000;
        }

        .download-merged-pdf-btn {
            background: linear-gradient(45deg, #388E3C, #2E7D32);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 20px;
            transition: all 0.3s ease;
            width: 100%;
        }

        .download-merged-pdf-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(56, 142, 60, 0.4);
        }
        
        @media (max-width: 768px) {
            .content-area {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .tab-container {
                padding: 20px;
            }
            .footer {
                flex-direction: column;
                align-items: center;
            }
            .footer-left, .footer-center, .footer-right {
                text-align: center;
                width: 100%;
                margin: 0;
            }
        }
        
        /* Estilos Adicionados para o Validador de Pagamento */
        #validatorTab body {
             font-family: 'Inter', sans-serif;
        }
        #validatorTab .file-input-container {
            position: relative;
            width: 100%;
            height: 12rem; /* 192px */
            border: 2px dashed #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out;
        }
        #validatorTab .file-input-container:hover {
            background-color: #f9fafb; /* gray-50 */
        }
        #validator-file-upload {
            display: none;
        }
        #validatorTab .copy-feedback {
            font-size: 0.8rem;
            color: #16a34a; /* green-600 */
            transition: opacity 0.5s ease-in-out;
        }
        
        @keyframes pop-in {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        #validatorTab .status-badge-animation {
            animation: pop-in 0.3s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('validatorTab')">ð¡ï¸ Validador de Pagamento</button>
            <button class="tab-button" onclick="openTab('ocrTab')">ð OCR de NÃºmeros</button>
            <button class="tab-button" onclick="openTab('barcodeTab')">ð§¹ Limpador de CÃ³digo de Barras</button>
            <button class="tab-button" onclick="openTab('joinPdfTab')">ð Juntar PDF</button>
        </div>

        <!-- ConteÃºdo da Aba Validador de Pagamento -->
        <div id="validatorTab" class="tab-content active">
            <div class="w-full bg-white rounded-xl p-6 md:p-8">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Validador de Guias de Pagamento</h1>
                    <p class="text-gray-500 mt-2">Envie uma imagem ou PDF da guia e a IA extrairÃ¡ os dados.</p>
                </div>

                <div class="mb-6">
                    <label for="validator-file-upload" class="file-input-container" id="validator-drop-zone">
                        <div class="text-center text-gray-500">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-2"></i>
                            <p class="font-semibold">Clique para enviar ou arraste e solte</p>
                            <p class="text-sm">PNG, JPG, WEBP ou PDF</p>
                        </div>
                    </label>
                    <input id="validator-file-upload" type="file" accept="image/png, image/jpeg, image/webp, application/pdf">
                </div>
                <div id="validator-image-preview-container" class="hidden mb-6 text-center">
                    <p class="text-sm font-medium text-gray-600 mb-2">PrÃ©-visualizaÃ§Ã£o do Documento:</p>
                    <img id="validator-image-preview" class="max-w-full max-h-80 mx-auto rounded-lg shadow-md" alt="Preview da guia de pagamento">
                </div>
                <div class="text-center mb-6">
                    <button id="validator-process-button" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 transition-all duration-300 shadow-md disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        <i class="fas fa-cogs mr-2"></i>
                        Extrair Dados
                    </button>
                </div>
                <div id="validator-result-section" class="space-y-4">
                    <div id="validator-loader" class="hidden flex items-center justify-center p-4 bg-gray-50 rounded-lg">
                        <i class="fas fa-spinner fa-spin fa-2x text-indigo-500"></i>
                        <p class="ml-3 text-gray-600">Analisando o documento... Por favor, aguarde.</p>
                    </div>
                    <div id="validator-error-message" class="hidden p-4 bg-red-100 text-red-700 rounded-lg flex items-center">
                        <i class="fas fa-exclamation-triangle mr-3"></i>
                        <span id="validator-error-text"></span>
                    </div>
                    <div id="validator-results-container" class="hidden p-6 bg-green-50 border border-green-200 rounded-lg shadow-sm">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 text-center">Dados ExtraÃ­dos com Sucesso!</h3>
                        <div class="space-y-4">
                            <div class="flex items-start p-3 bg-white rounded-md border">
                                <i class="fas fa-building fa-lg text-indigo-500 w-8 text-center mt-1"></i>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm text-gray-500">Fornecedor Identificado</p>
                                    <p id="validator-supplier-name" class="text-lg font-semibold text-gray-700"></p>
                                    <p id="validator-supplier-number" class="text-sm font-mono text-gray-500 mt-1"></p>
                                </div>
                            </div>
                            <div class="flex items-start p-3 bg-white rounded-md border">
                                <i class="fas fa-calendar-alt fa-lg text-indigo-500 w-8 text-center mt-1"></i>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm text-gray-500">Data de Vencimento</p>
                                    <p id="validator-due-date" class="text-lg font-semibold text-gray-700"></p>
                                    <div id="validator-due-date-status" class="mt-2 hidden">
                                        <span id="validator-due-date-badge" class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold shadow-md">
                                        </span>
                                    </div>
                                </div>
                                <button onclick="validatorCopyToClipboard('validator-due-date', 'validator-feedback-due-date')" class="p-2 text-gray-400 hover:text-indigo-600 ml-2">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <span id="validator-feedback-due-date" class="copy-feedback ml-2 opacity-0">Copiado!</span>
                            </div>
                            <div class="flex items-start p-3 bg-white rounded-md border">
                                <i class="fas fa-barcode fa-lg text-indigo-500 w-8 text-center mt-1"></i>
                                <div class="ml-4 flex-1 min-w-0">
                                    <p class="text-sm text-gray-500">CÃ³digo de Barras (Original)</p>
                                    <div class="bg-gray-100 p-2 rounded-md mt-1">
                                        <p id="validator-barcode-original" class="text-base font-mono text-gray-600 break-all"></p>
                                    </div>
                                    <p class="text-sm text-gray-500 mt-3">CÃ³digo de Barras (Apenas NÃºmeros)</p>
                                    <div class="bg-gray-50 p-2 rounded-md mt-1">
                                        <p id="validator-barcode-cleaned" class="text-base md:text-lg font-mono text-gray-800 break-all"></p>
                                    </div>
                                    <p id="validator-barcode-validation" class="text-sm text-yellow-600 font-sans mt-1 hidden"></p>
                                </div>
                                <button onclick="validatorCopyToClipboard('validator-barcode-cleaned', 'validator-feedback-barcode')" class="p-2 text-gray-400 hover:text-indigo-600 ml-2">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <span id="validator-feedback-barcode" class="copy-feedback ml-2 opacity-0">Copiado!</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ConteÃºdo da Aba OCR de NÃºmeros -->
        <div id="ocrTab" class="tab-content">
            <h1>ð Carrefour - ExtraÃ§Ã£o de NÃºmeros</h1>
            <div class="paste-area" id="ocrPasteArea">
                <div class="paste-icon">ð</div>
                <div class="paste-text">Cole sua imagem aqui com Ctrl+V</div>
                <div class="paste-hint">Ou arraste e solte uma imagem â¢ CÃ³digos de barras, documentos, screenshots</div>
                <input type="file" class="file-input" id="ocrFileInput" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('ocrFileInput').click()">
                    ð Selecionar Arquivo
                </button>
            </div>
            <div class="loading" id="ocrLoading">
                <div class="spinner"></div>
                <div id="ocrLoadingText">Inicializando OCR...</div>
            </div>
            <div class="content-area" id="ocrContentArea" style="display: none;">
                <div class="image-preview">
                    <div class="section-title">ð¼ï¸ Imagem Original</div>
                    <img id="previewImage" class="preview-img" alt="Preview da imagem">
                    <button class="ocr-btn" id="ocrProcessBtn" onclick="performOCR()">ð Extrair Texto</button>
                    <div class="usage-info" id="ocrUsageInfo" style="display: none;">
                        <strong>ð Uso:</strong> <span id="ocrUsageText"></span>
                    </div>
                </div>
                <div class="text-output">
                    <div class="section-title">
                        ð Texto ExtraÃ­do
                        <button class="copy-btn" id="copyOcrBtn" onclick="copyOcrText()" disabled>ð Copiar</button>
                    </div>
                    <div class="text-result" id="ocrTextResult">
                        <div class="empty-state">Cole ou envie uma imagem e clique em "Extrair Texto".</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ConteÃºdo da Aba Limpador de CÃ³digo de Barras -->
        <div id="barcodeTab" class="tab-content">
            <h1>ð§¹ Limpador de CÃ³digo de Barras</h1>
            <div class="barcode-input-section">
                <div class="paste-icon">ð</div>
                <div class="paste-text">Cole seu cÃ³digo de barras aqui</div>
                <textarea id="barcodeInput" placeholder="Ex: 1234.567-890 123,45"></textarea>
                <button class="barcode-clean-btn" id="cleanBarcodeBtn" onclick="cleanBarcode()">â¨ Limpar CÃ³digo</button>
            </div>
            <div class="barcode-output">
                <div class="section-title">
                    ð¢ CÃ³digo Limpo
                    <button class="copy-btn" id="copyBarcodeBtn" onclick="copyBarcode()" disabled>ð Copiar</button>
                </div>
                <div class="barcode-result-text" id="cleanedBarcodeResult">
                    <div class="empty-state">O cÃ³digo de barras limpo aparecerÃ¡ aqui.</div>
                </div>
            </div>
        </div>

        <!-- ConteÃºdo da Aba Juntar PDF -->
        <div id="joinPdfTab" class="tab-content">
            <h1>ð Carrefour - Juntar PDFs</h1>
            <p style="text-align: center; margin-bottom: 20px; color: #555;">
                Selecione mÃºltiplos arquivos PDF para combinÃ¡-los em um Ãºnico documento.
            </p>
            <div class="pdf-input-area">
                <div class="paste-icon">â</div>
                <div class="paste-text">Arraste e solte seus arquivos PDF aqui</div>
                <div class="paste-hint">Ou clique para selecionar arquivos (vocÃª pode selecionar vÃ¡rios)</div>
                <input type="file" class="file-input" id="pdfFileInput" accept=".pdf" multiple>
                <button class="upload-btn" onclick="document.getElementById('pdfFileInput').click()">ð Selecionar Arquivos PDF</button>
                <ul id="pdfFileList" class="pdf-file-list"></ul>
            </div>
            <div class="loading" id="pdfLoading" style="display: none;">
                <div class="spinner"></div>
                <div id="pdfLoadingText">Preparando para juntar PDFs...</div>
            </div>
            <button class="join-pdf-btn" id="joinPdfProcessBtn" onclick="joinPdfs()" disabled>â¨ Juntar PDFs Selecionados</button>
            <div class="pdf-output-area" id="pdfOutputArea" style="display: none;">
                <div class="section-title">â PDF Combinado</div>
                <div class="text-result" id="mergedPdfResult">
                    <div class="empty-state">O PDF resultante aparecerÃ¡ aqui.</div>
                </div>
                <button class="download-merged-pdf-btn" id="downloadPdfBtn" disabled>â¬ï¸ Baixar PDF Combinado</button>
            </div>
        </div>
        
    </div>

    <footer class="footer">
        <div class="footer-left">Â© 2025 - Ferramenta interna do Carrefour</div>
        <div class="footer-center">CSC - Transformar informaÃ§Ã£o em soluÃ§Ã£o</div>
        <div class="footer-right">Criador: Luiz Fraga</div> 
    </footer>

    <!-- Bibliotecas JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.4/tesseract.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        // --- FunÃ§Ãµes do Sistema de Abas ---
        function openTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            const clickedButton = Array.from(tabButtons).find(button => button.onclick.toString().includes(`openTab('${tabId}')`));
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        }

        // --- LÃ³gica para as abas originais (OCR, Barcode, Join PDF) ---
        const ocrPasteArea = document.getElementById('ocrPasteArea');
        const ocrLoading = document.getElementById('ocrLoading');
        const ocrLoadingText = document.getElementById('ocrLoadingText');
        const ocrContentArea = document.getElementById('ocrContentArea');
        const previewImage = document.getElementById('previewImage');
        const ocrTextResult = document.getElementById('ocrTextResult');
        const ocrFileInput = document.getElementById('ocrFileInput');
        const copyOcrBtn = document.getElementById('copyOcrBtn');
        const ocrProcessBtn = document.getElementById('ocrProcessBtn');
        const ocrUsageInfo = document.getElementById('ocrUsageInfo');
        const ocrUsageText = document.getElementById('ocrUsageText');
        let currentImageFile = null;
        let ocrWorker = null;

        const barcodeInput = document.getElementById('barcodeInput');
        const cleanBarcodeBtn = document.getElementById('cleanBarcodeBtn');
        const cleanedBarcodeResult = document.getElementById('cleanedBarcodeResult');
        const copyBarcodeBtn = document.getElementById('copyBarcodeBtn');

        const pdfFileInput = document.getElementById('pdfFileInput');
        const pdfFileList = document.getElementById('pdfFileList');
        const joinPdfProcessBtn = document.getElementById('joinPdfProcessBtn');
        const pdfLoading = document.getElementById('pdfLoading');
        const pdfLoadingText = document.getElementById('pdfLoadingText');
        const pdfOutputArea = document.getElementById('pdfOutputArea');
        const mergedPdfResult = document.getElementById('mergedPdfResult');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        let selectedPdfFiles = [];
        let mergedPdfBytes = null;

        if(ocrPasteArea) {
            ocrPasteArea.addEventListener('paste', handleOcrPaste);
            ocrPasteArea.addEventListener('dragover', handleOcrDragOver);
            ocrPasteArea.addEventListener('drop', handleOcrDrop);
            ocrPasteArea.addEventListener('dragleave', handleOcrDragLeave);
            ocrFileInput.addEventListener('change', handleOcrFileSelect);
        }
        if(barcodeInput) {
            barcodeInput.addEventListener('input', () => {
                const hasText = barcodeInput.value.trim().length > 0;
                cleanBarcodeBtn.disabled = !hasText;
                copyBarcodeBtn.disabled = true; 
                if (!hasText) {
                    cleanedBarcodeResult.innerHTML = '<div class="empty-state">O cÃ³digo de barras limpo aparecerÃ¡ aqui.</div>';
                }
            });
            cleanBarcodeBtn.disabled = true; 
            copyBarcodeBtn.disabled = true;
        }
        if(document.getElementById('joinPdfTab')) {
            document.getElementById('joinPdfTab').addEventListener('dragover', handlePdfDragOver);
            document.getElementById('joinPdfTab').addEventListener('drop', handlePdfDrop);
            document.getElementById('joinPdfTab').addEventListener('dragleave', handlePdfDragLeave);
            pdfFileInput.addEventListener('change', handlePdfFileSelect);
            downloadPdfBtn.addEventListener('click', downloadMergedPdf);
        }

        function handleOcrPaste(e) { e.preventDefault(); const items = e.clipboardData.items; for (let i = 0; i < items.length; i++) { if (items[i].type.indexOf('image') !== -1) { processOcrImage(items[i].getAsFile()); break; } } }
        function handleOcrDragOver(e) { e.preventDefault(); ocrPasteArea.classList.add('dragover'); }
        function handleOcrDrop(e) { e.preventDefault(); ocrPasteArea.classList.remove('dragover'); const files = e.dataTransfer.files; if (files.length > 0 && files[0].type.startsWith('image/')) { processOcrImage(files[0]); } }
        function handleOcrDragLeave(e) { e.preventDefault(); ocrPasteArea.classList.remove('dragover'); }
        function handleOcrFileSelect(e) { const file = e.target.files[0]; if (file) { processOcrImage(file); } }
        function processOcrImage(file) { if (file.size > 5 * 1024 * 1024) { ocrTextResult.innerHTML = '<div class="error-state">â ï¸ Arquivo muito grande! MÃ¡ximo 5MB.</div>'; return; } const reader = new FileReader(); reader.onload = function(e) { previewImage.src = e.target.result; currentImageFile = file; ocrContentArea.style.display = 'grid'; ocrTextResult.innerHTML = '<div class="empty-state">Clique em "Extrair Texto" para processar ð</div>'; copyOcrBtn.disabled = true; ocrProcessBtn.disabled = false; ocrUsageInfo.style.display = 'none'; }; reader.readAsDataURL(file); }
        
        async function performOCR() {
            if (!currentImageFile) return;
            showOcrLoading('Iniciando processo OCR...');
            try {
                if (!ocrWorker) {
                    ocrWorker = await Tesseract.createWorker({
                        logger: m => {
                            if (m.status === 'recognizing text') {
                                ocrLoadingText.textContent = `Extraindo texto... ${Math.round(m.progress * 100)}%`;
                            } else {
                                ocrLoadingText.textContent = 'Carregando engine OCR...';
                            }
                        }
                    });
                }
                await ocrWorker.loadLanguage('eng');
                await ocrWorker.initialize('eng');
                await ocrWorker.setParameters({
                    tessedit_char_whitelist: '0123456789'
                });
                const { data: { text, confidence } } = await ocrWorker.recognize(currentImageFile);
                let cleanText = text.replace(/[^0-9]/g, '');
                if (cleanText.includes('2063')) {
                    cleanText = cleanText.replaceAll('2063', '2963');
                }
                const charCount = cleanText.length;
                ocrTextResult.innerHTML = `<div class="success-state">â Texto extraÃ­do!</div>${cleanText}<div class="character-count-info">Caracteres: ${charCount}</div>`;
                copyOcrBtn.disabled = false;
                ocrUsageInfo.style.display = 'block';
                ocrUsageText.innerHTML = `ConfianÃ§a: ${Math.round(confidence)}%`;
            } catch (error) {
                console.error('Erro no OCR:', error);
                ocrTextResult.innerHTML = `<div class="error-state">â Erro no processamento OCR</div>`;
            } finally {
                hideOcrLoading();
                ocrProcessBtn.disabled = false;
            }
        }

        function showOcrLoading(message) { ocrLoading.style.display = 'block'; ocrLoadingText.textContent = message; }
        function hideOcrLoading() { ocrLoading.style.display = 'none'; }
        function copyOcrText() { const text = document.getElementById('ocrTextResult').innerText.replace(/â.*\n/, '').replace(/Caracteres: \d+/, '').trim(); if (text) { fallbackCopyTextToClipboard(text, copyOcrBtn); } }
        
        function cleanBarcode() {
            const rawBarcode = barcodeInput.value;
            const cleaned = rawBarcode.replace(/\D/g, ''); // Remove anything that is not a digit
            const charCount = cleaned.length;
            if (cleaned.length > 0) {
                cleanedBarcodeResult.innerHTML = `<div class="success-state">â CÃ³digo limpo!</div>${cleaned}<div class="character-count-info">Caracteres: ${charCount}</div>`;
                copyBarcodeBtn.disabled = false;
            } else {
                cleanedBarcodeResult.innerHTML = '<div class="empty-state">O cÃ³digo de barras limpo aparecerÃ¡ aqui.</div>';
                copyBarcodeBtn.disabled = true;
            }
        }

        function copyBarcode() {
            const rawBarcode = barcodeInput.value;
            const cleaned = rawBarcode.replace(/\D/g, ''); // Re-clean to ensure only numbers are copied
            if (cleaned) {
                fallbackCopyTextToClipboard(cleaned, copyBarcodeBtn);
            }
        }

        function handlePdfDragOver(e) { e.preventDefault(); e.stopPropagation(); document.getElementById('joinPdfTab').querySelector('.pdf-input-area').classList.add('dragover'); }
        function handlePdfDrop(e) { e.preventDefault(); e.stopPropagation(); document.getElementById('joinPdfTab').querySelector('.pdf-input-area').classList.remove('dragover'); const files = Array.from(e.dataTransfer.files).filter(file => file.type === 'application/pdf'); addPdfFilesToList(files); }
        function handlePdfDragLeave(e) { e.preventDefault(); e.stopPropagation(); document.getElementById('joinPdfTab').querySelector('.pdf-input-area').classList.remove('dragover'); }
        function handlePdfFileSelect(e) { const files = Array.from(e.target.files).filter(file => file.type === 'application/pdf'); addPdfFilesToList(files); }
        function addPdfFilesToList(files) { files.forEach(file => { const isDuplicate = selectedPdfFiles.some(f => f.name === file.name && f.size === file.size); if (!isDuplicate) { selectedPdfFiles.push(file); } }); renderPdfFileList(); updateJoinPdfButtonState(); }
        function removePdfFile(fileToRemove) { selectedPdfFiles = selectedPdfFiles.filter(file => file !== fileToRemove); renderPdfFileList(); updateJoinPdfButtonState(); }
        function renderPdfFileList() { pdfFileList.innerHTML = ''; selectedPdfFiles.forEach(file => { const li = document.createElement('li'); li.textContent = file.name; const btn = document.createElement('button'); btn.textContent = 'x'; btn.className = 'remove-file-btn'; btn.onclick = () => removePdfFile(file); li.appendChild(btn); pdfFileList.appendChild(li); }); }
        function updateJoinPdfButtonState() { joinPdfProcessBtn.disabled = selectedPdfFiles.length < 2; if (selectedPdfFiles.length === 0) { pdfOutputArea.style.display = 'none'; downloadPdfBtn.disabled = true; } }
        async function joinPdfs() { if (selectedPdfFiles.length < 2) return; pdfLoading.style.display = 'block'; joinPdfProcessBtn.disabled = true; try { const { PDFDocument } = PDFLib; const mergedPdf = await PDFDocument.create(); for (const file of selectedPdfFiles) { const arrayBuffer = await file.arrayBuffer(); const pdfDoc = await PDFDocument.load(arrayBuffer); const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices()); copiedPages.forEach(page => mergedPdf.addPage(page)); } mergedPdfBytes = await mergedPdf.save(); pdfOutputArea.style.display = 'flex'; mergedPdfResult.innerHTML = `<div class="success-state">â PDFs unidos! Total de pÃ¡ginas: ${mergedPdf.getPageCount()}</div>`; downloadPdfBtn.disabled = false; } catch (error) { console.error(error); mergedPdfResult.innerHTML = `<div class="error-state">â Erro ao juntar PDFs.</div>`; } finally { pdfLoading.style.display = 'none'; joinPdfProcessBtn.disabled = false; } }
        function downloadMergedPdf() { if (mergedPdfBytes) { const blob = new Blob([mergedPdfBytes], { type: 'application/pdf' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'pdfs_juntos_carrefour.pdf'; a.click(); URL.revokeObjectURL(url); } }
        function showCopyFeedback(buttonElement, actionText = 'Copiado') { const originalText = buttonElement.textContent; buttonElement.textContent = `â ${actionText}!`; buttonElement.style.background = 'linear-gradient(45deg, #4CAF50, #2E7D32)'; setTimeout(() => { buttonElement.textContent = originalText; if (buttonElement.classList.contains('download-merged-pdf-btn')) { buttonElement.style.background = 'linear-gradient(45deg, #388E3C, #2E7D32)'; } else { buttonElement.style.background = 'linear-gradient(45deg, #ED1C24, #C00000)'; } }, 2000); }
        function fallbackCopyTextToClipboard(text, buttonElement) { const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select(); try { document.execCommand('copy'); showCopyFeedback(buttonElement); } catch (err) { console.error('Falha ao copiar'); } document.body.removeChild(textArea); }
        
        // --- LÃ³gica para a nova aba "Validador de Pagamento" ---
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        const validatorFileUpload = document.getElementById('validator-file-upload');
        const validatorDropZone = document.getElementById('validator-drop-zone');
        const validatorImagePreviewContainer = document.getElementById('validator-image-preview-container');
        const validatorImagePreview = document.getElementById('validator-image-preview');
        const validatorProcessButton = document.getElementById('validator-process-button');
        const validatorLoader = document.getElementById('validator-loader');
        const validatorErrorMessage = document.getElementById('validator-error-message');
        const validatorErrorText = document.getElementById('validator-error-text');
        const validatorResultsContainer = document.getElementById('validator-results-container');
        const validatorDueDateElement = document.getElementById('validator-due-date');
        const validatorBarcodeOriginalElement = document.getElementById('validator-barcode-original');
        const validatorBarcodeCleanedElement = document.getElementById('validator-barcode-cleaned');
        const validatorBarcodeValidationElement = document.getElementById('validator-barcode-validation');
        const validatorDueDateStatusElement = document.getElementById('validator-due-date-status');
        const validatorSupplierNameElement = document.getElementById('validator-supplier-name');
        const validatorSupplierNumberElement = document.getElementById('validator-supplier-number');

        let validatorFileMimeType = null;
        let validatorBase64Image = null;

        function validatorImageToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }
        
        async function validatorRenderPdfToImage(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    try {
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({ scale: 2.0 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
                        resolve({
                            previewUrl: dataUrl,
                            base64: dataUrl.split(',')[1],
                            mimeType: 'image/jpeg'
                        });
                    } catch (pdfError) {
                        console.error('Erro ao processar PDF:', pdfError);
                        reject(new Error('NÃ£o foi possÃ­vel ler o arquivo PDF. Ele pode estar corrompido ou protegido.'));
                    }
                };
                fileReader.readAsArrayBuffer(file);
            });
        }

        async function validatorHandleFileSelect(selectedFile) {
            if (!selectedFile) return;
            const validTypes = ['image/png', 'image/jpeg', 'image/webp', 'application/pdf'];
            if (!validTypes.includes(selectedFile.type)) {
                validatorShowError('Por favor, selecione um arquivo de imagem (PNG, JPG, WEBP) ou PDF.');
                return;
            }
            validatorHideMessages();
            validatorProcessButton.disabled = true;
            validatorLoader.classList.remove('hidden');
            validatorLoader.querySelector('p').textContent = 'Processando o arquivo...';
            try {
                if (selectedFile.type === 'application/pdf') {
                    const pdfData = await validatorRenderPdfToImage(selectedFile);
                    validatorImagePreview.src = pdfData.previewUrl;
                    validatorBase64Image = pdfData.base64;
                    validatorFileMimeType = pdfData.mimeType;
                } else {
                    validatorImagePreview.src = URL.createObjectURL(selectedFile);
                    validatorBase64Image = await validatorImageToBase64(selectedFile);
                    validatorFileMimeType = selectedFile.type;
                }
                validatorImagePreviewContainer.classList.remove('hidden');
                validatorProcessButton.disabled = false;
            } catch (error) {
                console.error('Erro ao preparar arquivo:', error);
                validatorShowError(error.message || 'Ocorreu um erro ao processar o arquivo.');
                validatorImagePreviewContainer.classList.add('hidden');
            } finally {
                validatorLoader.classList.add('hidden');
                validatorLoader.querySelector('p').textContent = 'Analisando o documento... Por favor, aguarde.';
            }
        }

        validatorFileUpload.addEventListener('change', (e) => validatorHandleFileSelect(e.target.files[0]));
        validatorDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); validatorDropZone.classList.add('bg-indigo-50'); validatorDropZone.style.borderColor = '#4f46e5'; });
        validatorDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); validatorDropZone.classList.remove('bg-indigo-50'); validatorDropZone.style.borderColor = '#d1d5db'; });
        validatorDropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); validatorDropZone.classList.remove('bg-indigo-50'); validatorDropZone.style.borderColor = '#d1d5db'; const droppedFile = e.dataTransfer.files[0]; validatorHandleFileSelect(droppedFile); });

        function validatorShowLoader() { validatorHideMessages(); validatorLoader.classList.remove('hidden'); validatorProcessButton.disabled = true; }
        function validatorHideLoader() { validatorLoader.classList.add('hidden'); validatorProcessButton.disabled = false; }
        function validatorShowError(message) { validatorHideMessages(); validatorErrorText.textContent = message; validatorErrorMessage.classList.remove('hidden'); }
        function validatorShowResults(dueDate, rawBarcode, cleanedBarcode, supplierName, supplierNumber, validationMsg, dueDateStatus) {
            validatorHideMessages();
            validatorDueDateElement.textContent = dueDate || 'NÃ£o encontrado';
            validatorBarcodeOriginalElement.textContent = rawBarcode || 'NÃ£o encontrado';
            validatorBarcodeCleanedElement.textContent = cleanedBarcode || 'NÃ£o encontrado';
            validatorSupplierNameElement.textContent = supplierName || 'NÃ£o identificado';
            validatorSupplierNumberElement.textContent = supplierNumber ? `NÃºmero: ${supplierNumber}` : '';

            if (validationMsg) {
                validatorBarcodeValidationElement.textContent = validationMsg;
                validatorBarcodeValidationElement.classList.remove('hidden');
            }
            if (dueDateStatus) {
                const badge = document.getElementById('validator-due-date-badge');
                badge.className = dueDateStatus.classes;
                badge.textContent = `${dueDateStatus.icon} ${dueDateStatus.text}`;
                validatorDueDateStatusElement.classList.add('status-badge-animation');
                validatorDueDateStatusElement.classList.remove('hidden');
            }
            validatorResultsContainer.classList.remove('hidden');
        }
        function validatorHideMessages() {
            validatorLoader.classList.add('hidden');
            validatorErrorMessage.classList.add('hidden');
            validatorResultsContainer.classList.add('hidden');
            validatorBarcodeValidationElement.classList.add('hidden');
            if (validatorDueDateStatusElement.classList.contains('status-badge-animation')) {
                validatorDueDateStatusElement.classList.remove('status-badge-animation');
            }
            validatorDueDateStatusElement.classList.add('hidden');
        }

        function validatorCopyToClipboard(elementId, feedbackId) {
            const textToCopy = document.getElementById(elementId).textContent;
            if (!textToCopy || textToCopy === 'NÃ£o encontrado') return;
            try {
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                const feedbackElement = document.getElementById(feedbackId);
                feedbackElement.style.opacity = '1';
                setTimeout(() => { feedbackElement.style.opacity = '0'; }, 2000);
            } catch (err) {
                console.error('Falha ao copiar o texto: ', err);
            }
        }

        validatorProcessButton.addEventListener('click', async () => {
            if (!validatorBase64Image) {
                validatorShowError('Nenhum documento selecionado para processar.');
                return;
            }
            const apiKey = "AIzaSyA4v_xAbxl3usCinZF0UREoS5GXo6m07FM"; 
            validatorShowLoader();
            
            const predefinedSupplierList = `3010010117,AMERICAN CHAMBER
3010012976,BANCO DO BRASIL S.A
3010015717,CAIXA ECONOMICA
3010016266,CONSELHO REGIONAL DE FARMACIA 
3010012045,CONSELHO REGIONAL DE MEDICINA VETERINARIA 
3070000164,BANCO DE BRASILIA
3050000121,ESCRIVÃO PARTICULAR DE CURITIBA
3050000083,ESTADO DE GOIÃS
3050000081,ESTADO DO RIO GRANDE DO SUL
3010012036,FUNJECC CAMPO GRANDE 
3050000121,FUNJUS
3050000076,GOVERNO DO ESTADO DO RIO DE JANEIRO 
3010012197,IBAMA
3010016730,INMETRO
3050000084,ESTADO DO MUNICIPIO DE MATO GROSSO DO SUL
3010028766,ESTADO DO CEARÃ
3050000030,MUNICIPIO DE BELFORD ROXO 
3050000023,MUNICIPIO DE JUIZ DE FORA 
3050000033,MUNICÃPIO DE GUARUJÃ
3010016308,MUNICIPIO DE SÃO PAULO
3050000039,MUNICIPIO DE PRAIA GRANDE 
3050000002,MUNICIPIO DE RIBEIRÃO PRETO 
3050000035,MUNICIPIO DE TAUBATÃ
3050000011,MUNICIPIO DE SOROCABA
3050000139,MUNICIPIO JABOATAO DOS GUARARAPES
3050000073,PREFEITURA  DE CANOAS 
3050000050,PREFEITURA BELO HORIZONTE
3050000016,PREFEITURA DE ANAPOLIS
3050000015,PREFEITURA DE APARECIDA DE GO 
3050000057,prefeitura de campinas
3050000017,PREFEITURA DE GOIANIA 
3010027337,PREFEITURA DE SÃO VICENTE
3050000034,PREFEITURA DE LIMEIRA 
3050000028,PREFEITURA DE NOVA IGUAÃU 
3050000040,PREFEITURA DE PIRACICABA
3050000068,PREFEITURA DE PORTO ALEGRE
3050000075,PREFEITURA DE RECIFE 
3050000006,PREFEITURA DE SAO BERNARDO DO CAMPO
3050000058,PREFEITURA DE SANTOS 
3010016265,PREFEITURA DO RIO DE JANEIRO 
3050000032,PREFEITURA INDAIATUBA
3010011977,PREFEITURA JOÃO PESSOA
3010009076,PREFEITURA MUNICIPAL DE GUARULHOS 
3050000005,PREFEITURA SÃO JOSÃ DO RIO PRETO
3010027253,PREFEITURA SÃO JOSÃ DOS CAMPOS
3050000047,PREFEITURA MUNICIPAL DE GRAVATAÃ
3050000020,PREFEITURA DE FORTALEZA
3010020477,PREFEITURA MUNICIPAL DE VITORIA DA CONQUISTA
3050000071,PREFEITURA MUNICIPAL DE CABEDELO
3050000059,PREFEITURA DO MUNICIPIO DE SAO CAETANO DO SUL
3010027209,PROCON CAMPINAS
3010012146,PROCON SP
3010012047,PROCON MUNICIPAL DE NATAL
3010012256,PROCURADORIA DO RJ 
3010012288,REGRISTRADORES.ORG
3050000106,SECRETARIA DA RECEITA FEDERAL
3050000079,SECRETARIA DO ESTADO DA FAZENDA 
3050000082,SECRETARIA DO ESTADO DA FAZENDA 
3050000119,SECRETARIA DO SUPERIO TRIBUNAL FEDERAL 
3050000108,SECRETARIA DO TESOURO NACIONAL
3050000079,SEFAZ ES
3050000083,SEFAZ GO 
3050000109,SEFAZ RJ
3010019427,SEFAZ RS 
3050000111,SEFAZ SP
3010019715,SEFAZ TO 
3010012273,SUPREMO TRIBUNAL FEDERAL
3010012010,TJ AMAZONAS 
3050000122,TJ CEARA 
3050000104,TJ DISTRITO FEDERAL
3050000103,TJ ESPIRITO SANTO
3010021082,TJ GOIAS
3050000100,TJ MINAS GERAIS
3010012008,TJ MS
3050000094,TJ PARAIBA
3010021234,TJ PERNAMBUCO
3050000121,TJ PR -  PARANA
3050000102,TJ RIO DE JANEIRO
3010012110,TJ RIO GRANDE DO NORTE
3010011934,TJ SANTA CATARINA 
3050000101,TJ SÃO PAULO 
3010030378,TJ BAHIA
3010038603,TJ MARANHAO
3010023489,TJ PARA
3010012041,CONSELHO REGIONAL DE MEDICINA VETERINARIA - GO
3010012050,AGENCIA NACIONAL DE VIGILANCIA SANITARIA
3010019896,FUNDO S MUNICIPAL DE CAMPIINAS
3010012036,FUNDO ESPECIAL PARA INSTA
3010012073,JUNTA COMERCIAL DO ESTADO NO PARANÃ
3050000119,SUPERIOR TRIBUNAL DE JUSTIÃA 
3050000019,PREFEITURA MANAUS
3010018843,SECRETARIA DO SUPERIO TRIBUNAL FEDERAL MINAS GERAIS
3010021234,Tribunal de JustiÃ§a de Pernambuco
3010042592,SERGIPE JUSTICA ESTADUAL
3050000116,Bahia
3010050178,FUNDO ESTADUAL DE PROTECAO E DEFESA DO C
3010027209,PROCON-MUNICIAL CAMPINAS
3010008367,PREFEITURA MUNICIPAL DE VITORIA
3050000119,SECRETARIA DO SUPERIOR TRIBUNAL JUSTIÃA
3050000088,ESTADO DA PARAIBA
3010049991,PROCON BA SJDH
3010043339,PREFEITURA MUNICIPAL FEIRA DE SANTANA
3050000152,OPERADOR NACIONAL
3010018843,SECRETARIA DO ESTADO DA FAZENDA  DE MINAS GERAIS
3010045642, FUNDO ESPECIAL DE MODERNI <TJ ALAG
3010045413,PREFEITURA MUNICIAL DE CHAPECO
3010042394,AGENCIA NACIONAL DE SAÃDE
3010016303,JUNTA COMERCIAL DO ESTADO RIO GRANDE DO NORTE
3050000060,PREFEITURA DE LONDRINA
3010039992,ESTADO DO MARANHAO
3050000008,MUNICIPIO SAO GONÃALO
3010011487,CEEE
3010043657,ASSOCIAÃÃO DOS PROCURADOS ESTADO DE ALAGOAS
3010051148,PROCON FUNDO DIFUS
3050000043,MUNICIPIO DE BARUERI
3050000048,MUNICIPIO DE CAXIAS DO SUL
3010012205,PROCON JOAO PESSOA
3010019793,GOVERNO DO ESTADO DE ALAGOAS
3010043683,BANCO DO ESTADO DE SERGIPE   
3010050191,ALPHA DEPOSITO DE MERCADORIA
3010043494,FUNDO DEFESA DOS DIREITOS
3010012146,PROCON
3010042544,CREA-RS
3010016266,CONSELHO FEDERAL FARMACIA
3010016282,MUNICIPIO DO CABO DE SANTO
3010027209,PROCON - PREF MUNI CAMPINAS
3010043393,PREFEITURA MUNICIAL SALVADOR
3010043543, MUNICIPIO DE JANDIRA
3010012047,INST MUN PROT DEF CONSUMIDOR
3010049416,MUNICPIO DE LAURO DE FREI
3050000086,SECRETARIA DA FAZENDA DO CEARA
3050000080,SECRETARIA DA FAZENDA DO DF
3050000017,PREFEITURA DE GOIANIA
3050000083,ESTADO DE GOIAS SEC DA ECONOMIA
3050000086,SEFAZ CEARA
3010043207,FUNDO MUNICIPAL DE SAUDE
3010044959,MUNICIPIO MARINGA
3010043162,AGENCIA DESTAK DE PUBLICIDADE
3050000018,PREFEITURA CAMPO GRANDE
3010055906,SANTANDER AUTO S.A.
3010055481,JADY FERNANDES BRASILEIRO 4110
3010055141,CURITIBA - SECRETARIA MUNICIPAL DO MEIO AMBIENTE
3010055096,COORDENAÃÃO-GERAL DE ORÃAMENTO, FINANÃAS E CONTABILIDADE
3010041743,MUNICIPIO DE UBERLANDIA
3010054936,FUNDO ESPECIAL DO PODER JUDICIARIO DO ESTADO DE RORAIMA
3050000155,COLEGIO NOTARIAL DO BRASIL SECAO DE SAO PAULO
3050000077,ESTADO DO PARANÃ
3010012044,CONSELHO FFEDERAL MEDICINA RJ
3010041355,CAIXA ESPECIAL SUCUMBENCIA
3050000062,MUNICIPIO DE BALNEARIO CAMBORIU
3010023489,TJ PARA
3010012320,MUNICIPIO DE CONTAGEM
3010043434,MUNICIPIO DE SANTA CRUZ DO SUL
3010024818,PREFEITURA FERRAZ DE VASCONCELOS
3050000159,MUNICIPIO DE CAMPO LARGO
3050000160,CONSELHO REGIONAL DE ENGENHARIA E AGRONOMIA DO ESTADO DE RONDONIA
3010053714,CARTORIO DO 5 OFICIO DE JUSTICA DA COMARCA DE SAO GONCALO
3050000089,GOVERNO DO ESTADO DE PERNAMBUCO
3010053919,4Âº SERVICO DE REGISTRO DE IMOVEIS DA CAPITAL
3010042769,PREFEITURA FOZ IGUAÃU
3010051221,FECON
3010043107,MUNICIPIO DE AMERICANA
3010053749,FUNDO MUNICIPAL PROTEÃÃO E DEFESA DO CONSUMIDOR
3010035659,PREFEITURA MACEIO
3010043589,PREJEITURA ARACAJU
3010016266,"CONSELHO FEDERAL DE FARMÃCIA - CRF-PR"
3010043162,Destak Publicidade 
3010054209,"FUNDO REGIONAL DE PROTECAO E DEFESA DO CONSUMIDOR-FRPDC"
3010054210,SECRETARIA DE ESTADO DO AMBIENTE E SUSTENTABILIDADE
3010054432,ASSOCIACAO DOS PROCURADORES E ADVOGADOS DO MUNICIPIO DE DIADEMA
3050000049,MUNICIPIO DE DIADEMA
3010017744,FGTS
3010042591,MUNICIPIO ITAJAÃ
3010054705,FUNDO AMBIENTAL
3010054933,5 OFICIAL DE REGISTRO DE IMOVEIS DA CAPITAL
3050000122,TRIBUNAL DE JUSTICA CEARÃ
3010041986,TRIBUNAL DE JUSTICA PERNAMBUCO
3050000017,PREFEITURA DE GOIANIA
3050000094,TRIBUNAL DE JUSTICA PARAÃBA
3050000121,FUNJUS
3050000121,ESCRIVÃO PARTICULAR DE CURITIBA
3050000111,SEFAZ SP`;
            
            const prompt = `
                Sua tarefa Ã© analisar a imagem de uma guia de pagamento e extrair informaÃ§Ãµes com MÃXIMA precisÃ£o.

                A seguir, uma lista de possÃ­veis fornecedores no formato "NÃMERO,NOME":
                ---
                ${predefinedSupplierList}
                ---

                Siga estes passos:
                1.  **Extraia a Linha DigitÃ¡vel Completa:** Localize o cÃ³digo de barras e extraia a sequÃªncia completa, incluindo todos os espaÃ§os, pontos e traÃ§os, exatamente como estÃ¡ na imagem.
                2.  **Extraia a Data de Vencimento:** Localize a data e formate-a como DD/MM/AAAA.
                3.  **Identifique o Fornecedor:** Analise a guia em busca de um nome ou nÃºmero que corresponda a um dos fornecedores na lista.
                4.  **Formate a Resposta:** Retorne um objeto JSON com as chaves "vencimento", "codigo_barras", e "fornecedor". O valor de "fornecedor" DEVE SER UM OBJETO contendo as chaves "numero" e "nome". Se nenhum fornecedor for encontrado, retorne null para o objeto "fornecedor".

                Exemplo de resposta JSON:
                {
                  "vencimento": "15/10/2025",
                  "codigo_barras": "85850000020-7 49220280187-7 40000992455-3 43915031818-0",
                  "fornecedor": {
                      "numero": "8774",
                      "nome": "Fornecedor Exemplo A"
                  }
                }
            `;
            const payload = {
                contents: [{ parts: [ { text: prompt }, { inlineData: { mimeType: validatorFileMimeType, data: validatorBase64Image } } ] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorBody = await response.json();
                    const detailedMessage = errorBody.error?.message || `Status ${response.status}`;
                    throw new Error(`Erro da API: ${detailedMessage}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    const textResponse = result.candidates[0].content.parts[0].text;
                    const cleanTextResponse = textResponse.replace(/^```json\s*|```\s*$/g, '');
                    const parsedJson = JSON.parse(cleanTextResponse);
                    const dueDate = parsedJson.vencimento;
                    const rawBarcode = parsedJson.codigo_barras;
                    const supplierObject = parsedJson.fornecedor;
                    const supplierName = supplierObject ? supplierObject.nome : null;
                    const supplierNumber = supplierObject ? supplierObject.numero : null;
                    const cleanedBarcode = rawBarcode ? rawBarcode.replace(/\D/g, '') : null;
                    let validationMessage = null;
                    if (cleanedBarcode && !(cleanedBarcode.length === 47 || cleanedBarcode.length === 48)) {
                        validationMessage = `AtenÃ§Ã£o: O cÃ³digo possui ${cleanedBarcode.length} dÃ­gitos. O padrÃ£o Ã© 47 (boletos) ou 48 (tributos).`;
                    }
                    let dueDateStatus = null;
                    if (dueDate && /^\d{2}\/\d{2}\/\d{4}$/.test(dueDate)) {
                        const parts = dueDate.split('/');
                        const dueDateObject = new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const threeDaysFromNow = new Date();
                        threeDaysFromNow.setHours(0, 0, 0, 0);
                        threeDaysFromNow.setDate(today.getDate() + 3);
                        if (dueDateObject < today) {
                            dueDateStatus = { text: "GUIA VENCIDA", icon: "ð¢", classes: "inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold shadow-md bg-red-500 text-white" };
                        } else if (dueDateObject <= threeDaysFromNow) {
                            const daysDiff = Math.ceil((dueDateObject - today) / (1000 * 60 * 60 * 24));
                            const dayText = daysDiff <= 1 ? 'DIA' : 'DIAS';
                            dueDateStatus = { text: `VENCE EM ${daysDiff} ${dayText}`, icon: "ð", classes: "inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold shadow-md bg-yellow-500 text-white" };
                        } else {
                            dueDateStatus = { text: "PAGAMENTO EM DIA", icon: "ð", classes: "inline-flex items-center px-3 py-1.5 rounded-full text-sm font-bold shadow-md bg-green-500 text-white" };
                        }
                    }
                    if (dueDate || cleanedBarcode) {
                        validatorShowResults(dueDate, rawBarcode, cleanedBarcode, supplierName, supplierNumber, validationMessage, dueDateStatus);
                    } else {
                        validatorShowError('NÃ£o foi possÃ­vel extrair os dados. Tente um documento com melhor qualidade.');
                    }
                } else {
                    if (result.candidates && result.candidates[0].finishReason === 'SAFETY') {
                        validatorShowError('A anÃ¡lise foi bloqueada por seguranÃ§a. A imagem pode conter informaÃ§Ãµes sensÃ­veis.');
                    } else {
                        validatorShowError('A resposta da IA nÃ£o continha os dados esperados.');
                    }
                }
            } catch (error) {
                console.error('Erro ao chamar a API do Gemini:', error);
                validatorShowError(error.message || 'Ocorreu um erro de comunicaÃ§Ã£o com a IA.');
            } finally {
                validatorHideLoader();
            }
        });

        // Garante que a primeira aba esteja ativa ao carregar a pÃ¡gina
        document.addEventListener('DOMContentLoaded', () => {
            openTab('validatorTab');
            if(document.getElementById('joinPdfTab')) {
                updateJoinPdfButtonState();
            }
        });
    </script>
</body>
</html>
