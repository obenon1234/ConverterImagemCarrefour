<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas Carrefour: OCR e Limpador de C√≥digo de Barras</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0050A4; /* Azul do Carrefour */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            color: white;
        }

        .tab-container {
            max-width: 1200px;
            width: 100%;
            background: #FFFFFF;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #333333;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
            flex-wrap: wrap; /* Permite quebrar em v√°rias linhas em telas pequenas */
        }

        .tab-button {
            background: #D0D0D0; /* Cinza claro para abas inativas */
            color: #333333;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .tab-button:hover {
            background: #C0C0C0;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .tab-button.active {
            background: linear-gradient(45deg, #ED1C24, #C00000); /* Vermelho do Carrefour */
            color: white;
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .tab-content {
            display: none; /* Conte√∫do da aba oculto por padr√£o */
        }

        .tab-content.active {
            display: block; /* Conte√∫do da aba ativa vis√≠vel */
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            color: #333333;
        }

        /* Estilos para o OCR e Limpador de C√≥digo de Barras (similaridade) */
        .paste-area, .barcode-input-section { /* Renomeado para evitar conflito com input-area */
            background: #E0E0E0;
            border: 3px dashed rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
            color: #333333;
        }

        .paste-area:hover, .barcode-input-section:hover {
            border-color: rgba(0, 0, 0, 0.6);
            background: #D0D0D0;
            transform: translateY(-2px);
        }

        .paste-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.7;
            color: #333333;
        }

        .paste-text {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .paste-hint {
            opacity: 0.8;
            font-size: 0.8rem;
            margin-bottom: 15px;
        }

        .upload-btn, .barcode-clean-btn {
            background: linear-gradient(45deg, #ED1C24, #C00000);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .upload-btn:hover, .barcode-clean-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .ocr-btn {
            background: linear-gradient(45deg, #ED1C24, #C00000);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 20px 0;
            transition: all 0.3s ease;
            width: 100%;
        }

        .ocr-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .ocr-btn:disabled, .barcode-clean-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .content-area { /* OCR content area */
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .image-preview, .text-output, .barcode-output { /* Reutiliza estilos */
            background: #E0E0E0;
            border-radius: 15px;
            padding: 20px;
            min-height: 300px; /* Ajustado para caber no contexto de abas */
            display: flex;
            flex-direction: column;
            color: #333333;
        }

        .section-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333333;
        }

        .preview-img {
            max-width: 100%;
            max-height: 250px; /* Ajustado para caber no contexto de abas */
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            object-fit: contain;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        .text-result, .barcode-result-text { /* Estilos para texto de sa√≠da */
            background: #CCCCCC;
            border-radius: 10px;
            padding: 15px;
            min-height: 150px; /* Ajustado para caber no contexto de abas */
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            white-space: nowrap;
            overflow-x: auto;
            overflow-y: auto;
            border: 1px solid rgba(0, 0, 0, 0.2);
            flex-grow: 1;
            color: #333333;
        }

        .copy-btn {
            background: linear-gradient(45deg, #ED1C24, #C00000);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            margin-left: auto;
        }

        .copy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(237, 28, 36, 0.4);
        }

        .copy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .file-input {
            display: none;
        }

        .language-selector { /* Este seletor foi ocultado no OCR, mas mantido caso queira reativar */
            margin: 15px 0;
            display: none; 
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .lang-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .lang-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .lang-btn.active {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            border-color: #FF9800;
        }

        /* Estilos para a √°rea de input do limpador de c√≥digo de barras */
        .barcode-input-section textarea {
            width: 100%;
            min-height: 120px; /* Altura razo√°vel para colar c√≥digos */
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 1rem;
            margin-top: 15px; /* Espa√ßo entre o hint e o textarea */
        }

        /* Mensagens de estado */
        .loading {
            display: none;
            text-align: center;
            padding: 30px 20px;
            background: #E0E0E0;
            border-radius: 15px;
            margin-bottom: 30px;
            color: #333333;
        }

        .spinner {
            border: 3px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top: 3px solid #333333;
            width: 35px;
            height: 35px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            color: rgba(51, 51, 51, 0.6);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        .error-state {
            color: #D32F2F;
            text-align: center;
            padding: 10px;
        }

        .success-state {
            color: #388E3C;
            font-weight: bold;
            margin-bottom: 15px;
        }

        .warning-state {
            color: #FBC02D;
            margin-bottom: 15px;
        }

        .usage-info {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 0.8rem;
            color: #333333;
        }

        .character-count-info {
            font-size: 0.85rem;
            margin-top: 10px;
            opacity: 0.8;
            color: rgba(51, 51, 51, 0.7);
            text-align: right;
        }

        /* Estilos do rodap√© */
        .footer {
            margin-top: 40px;
            text-align: center;
            color: white;
            font-size: 0.75rem;
            padding: 10px 20px;
            background-color: #0050A4;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .footer-left, .footer-center, .footer-right {
            flex: 1;
            min-width: 150px;
            text-align: center;
        }

        .footer-left {
            text-align: left;
        }

        .footer-right {
            text-align: right;
        }

        /* Media Queries para Responsividade */
        @media (max-width: 768px) {
            .content-area {
                grid-template-columns: 1fr; /* Coluna √∫nica em telas menores para OCR */
                gap: 20px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .tab-container {
                padding: 20px;
            }
            .footer {
                flex-direction: column;
                align-items: center;
            }
            .footer-left, .footer-center, .footer-right {
                text-align: center;
                width: 100%;
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="tab-container">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="openTab('ocrTab')">üîç OCR de N√∫meros</button>
            <button class="tab-button" onclick="openTab('barcodeTab')">üßπ Limpador de C√≥digo de Barras</button>
        </div>

        <!-- Conte√∫do da Aba OCR de N√∫meros -->
        <div id="ocrTab" class="tab-content active">
            <h1>üîç Carrefour - Extra√ß√£o de N√∫meros</h1>
            
            <div class="api-config" style="display: none;">
                <strong>üí° OCR Offline:</strong> Este app usa Tesseract.js para reconhecimento de texto diretamente no seu navegador.
                <br><strong>‚úÖ Funciona sem internet</strong> ‚Ä¢ <strong>üîí Seus dados ficam privados</strong> ‚Ä¢ <strong>‚ö° Processamento local</strong>
            </div>
            
            <div class="paste-area" id="ocrPasteArea">
                <div class="paste-icon">üìã</div>
                <div class="paste-text">Cole sua imagem aqui com Ctrl+V</div>
                <div class="paste-hint">Ou arraste e solte uma imagem ‚Ä¢ C√≥digos de barras, documentos, screenshots</div>
                <input type="file" class="file-input" id="ocrFileInput" accept="image/*">
                <button class="upload-btn" onclick="document.getElementById('ocrFileInput').click()">
                    üìÅ Selecionar Arquivo
                </button>
            </div>

            <div class="loading" id="ocrLoading">
                <div class="spinner"></div>
                <div id="ocrLoadingText">Inicializando OCR...</div>
            </div>

            <div class="content-area" id="ocrContentArea" style="display: none;">
                <div class="image-preview">
                    <div class="section-title">
                        üñºÔ∏è Imagem Original
                    </div>
                    <div class="language-selector">
                        <div style="font-size: 0.9rem; margin-bottom: 5px;">Idioma:</div>
                        <button class="lang-btn active" data-lang="eng">üá∫üá∏ N√∫meros (Ingl√™s)</button>
                        <button class="lang-btn" data-lang="por">üáßüá∑ Portugu√™s (Texto Geral)</button>
                        <button class="lang-btn" data-lang="spa">ÔøΩüá∏ Espanhol (Texto Geral)</button>
                        <button class="lang-btn" data-lang="fre">üá´üá∑ Franc√™s (Texto Geral)</button>
                    </div>
                    <img id="previewImage" class="preview-img" alt="Preview da imagem">
                    
                    <button class="ocr-btn" id="ocrProcessBtn" onclick="performOCR()">
                        üîç Extrair Texto
                    </button>
                    
                    <div class="usage-info" id="ocrUsageInfo" style="display: none;">
                        <strong>üìä Uso:</strong> <span id="ocrUsageText"></span>
                    </div>
                </div>

                <div class="text-output">
                    <div class="section-title">
                        üìù Texto Extra√≠do
                        <button class="copy-btn" id="copyOcrBtn" onclick="copyOcrText()" disabled>üìã Copiar</button>
                    </div>
                    
                    <div class="text-result" id="ocrTextResult">
                        <div class="empty-state">Cole ou envie uma imagem e clique em "Extrair Texto".</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Conte√∫do da Aba Limpador de C√≥digo de Barras -->
        <div id="barcodeTab" class="tab-content">
            <h1>üßπ Limpador de C√≥digo de Barras</h1>
            <div class="barcode-input-section">
                <div class="paste-icon">üìÑ</div>
                <div class="paste-text">Cole seu c√≥digo de barras aqui</div>
                <textarea id="barcodeInput" placeholder="Ex: 1234.567-890 123,45"></textarea>
                <button class="barcode-clean-btn" id="cleanBarcodeBtn" onclick="cleanBarcode()">
                    ‚ú® Limpar C√≥digo
                </button>
            </div>
            <div class="barcode-output">
                <div class="section-title">
                    üî¢ C√≥digo Limpo
                    <button class="copy-btn" id="copyBarcodeBtn" onclick="copyBarcode()" disabled>üìã Copiar</button>
                </div>
                <div class="barcode-result-text" id="cleanedBarcodeResult">
                    <div class="empty-state">O c√≥digo de barras limpo aparecer√° aqui.</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-left">¬© 2025 - Ferramenta interna do Carrefour</div>
        <div class="footer-center">CSC - Transformar informa√ß√£o em solu√ß√£o</div>
        <div class="footer-right">Criador: Luiz Fraga</div> 
    </footer>

    <!-- Tesseract.js CDN (vers√£o 4.1.4) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.4/tesseract.min.js"></script>
    <script>
        // --- Fun√ß√µes do Sistema de Abas ---
        function openTab(tabId) {
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // --- Vari√°veis e Refer√™ncias do DOM para OCR ---
        const ocrPasteArea = document.getElementById('ocrPasteArea');
        const ocrLoading = document.getElementById('ocrLoading');
        const ocrLoadingText = document.getElementById('ocrLoadingText');
        const ocrContentArea = document.getElementById('ocrContentArea');
        const previewImage = document.getElementById('previewImage');
        const ocrTextResult = document.getElementById('ocrTextResult');
        const ocrFileInput = document.getElementById('ocrFileInput');
        const copyOcrBtn = document.getElementById('copyOcrBtn');
        const ocrProcessBtn = document.getElementById('ocrProcessBtn');
        const ocrUsageInfo = document.getElementById('ocrUsageInfo');
        const ocrUsageText = document.getElementById('ocrUsageText');
        
        let currentImageFile = null;
        let currentLanguage = 'eng'; 
        let ocrWorker = null;
        let isWorkerInitializing = false; 

        // --- Vari√°veis e Refer√™ncias do DOM para Limpador de C√≥digo de Barras ---
        const barcodeInput = document.getElementById('barcodeInput');
        const cleanBarcodeBtn = document.getElementById('cleanBarcodeBtn');
        const cleanedBarcodeResult = document.getElementById('cleanedBarcodeResult');
        const copyBarcodeBtn = document.getElementById('copyBarcodeBtn');

        // --- Event Listeners para OCR ---
        ocrPasteArea.addEventListener('paste', handleOcrPaste);
        ocrPasteArea.addEventListener('dragover', handleOcrDragOver);
        ocrPasteArea.addEventListener('drop', handleOcrDrop);
        ocrPasteArea.addEventListener('dragleave', handleOcrDragLeave);
        ocrFileInput.addEventListener('change', handleOcrFileSelect);

        // --- Event Listeners para Limpador de C√≥digo de Barras ---
        barcodeInput.addEventListener('input', () => {
            const hasText = barcodeInput.value.trim().length > 0;
            cleanBarcodeBtn.disabled = !hasText;
            copyBarcodeBtn.disabled = !hasText; 
            if (!hasText) {
                 cleanedBarcodeResult.innerHTML = '<div class="empty-state">O c√≥digo de barras limpo aparecer√° aqui.</div>';
            }
        });
        cleanBarcodeBtn.disabled = true; 
        copyBarcodeBtn.disabled = true;

        // --- Fun√ß√µes do OCR (mantidas e adaptadas para IDs √∫nicos) ---
        function handleOcrPaste(e) {
            e.preventDefault();
            const items = e.clipboardData.items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const file = items[i].getAsFile();
                    processOcrImage(file);
                    break;
                }
            }
        }

        function handleOcrDragOver(e) {
            e.preventDefault();
            ocrPasteArea.classList.add('dragover');
        }

        function handleOcrDrop(e) {
            e.preventDefault();
            ocrPasteArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type.startsWith('image/')) {
                processOcrImage(files[0]);
            }
        }

        function handleOcrDragLeave(e) {
            e.preventDefault();
            ocrPasteArea.classList.remove('dragover');
        }

        function handleOcrFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                processOcrImage(file);
            }
        }

        function processOcrImage(file) {
            if (file.size > 5 * 1024 * 1024) { // 5MB
                ocrTextResult.innerHTML = '<div class="error-state">‚ö†Ô∏è Arquivo muito grande! M√°ximo 5MB.<br>Compacte a imagem e tente novamente.</div>';
                ocrProcessBtn.disabled = true;
                copyOcrBtn.disabled = true;
                ocrUsageInfo.style.display = 'none';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                currentImageFile = file;
                ocrContentArea.style.display = 'grid'; // Exibir a √°rea de conte√∫do
                
                ocrTextResult.innerHTML = '<div class="empty-state">Clique em "Extrair Texto" para processar üëÜ</div>';
                copyOcrBtn.disabled = true;
                ocrProcessBtn.disabled = false;
                ocrUsageInfo.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function getLanguageName(code) {
            const names = { 'por': 'por', 'eng': 'eng', 'spa': 'spa', 'fre': 'fra' };
            return names[code] || 'desconhecido';
        }

        function showOcrLoading(message = 'Inicializando OCR...') {
            ocrLoading.style.display = 'block';
            ocrLoadingText.textContent = message;
            ocrProcessBtn.disabled = true;
            copyOcrBtn.disabled = true;
            ocrTextResult.innerHTML = '<div class="empty-state">Aguarde...</div>';
        }

        function hideOcrLoading() {
            ocrLoading.style.display = 'none';
        }

        async function performOCR() {
            if (!currentImageFile) {
                ocrTextResult.innerHTML = '<div class="error-state">‚ùå Nenhuma imagem carregada para processar.</div>';
                return;
            }
            if (typeof Tesseract === 'undefined') {
                ocrTextResult.innerHTML = '<div class="error-state">‚ùå Tesseract.js n√£o foi carregado. Recarregue a p√°gina ou verifique sua conex√£o com a internet.</div>';
                return;
            }

            showOcrLoading('Iniciando processo OCR...');
            ocrProcessBtn.disabled = true;

            try {
                if (!ocrWorker) {
                    isWorkerInitializing = true;
                    ocrLoadingText.textContent = 'Carregando engine OCR (primeira vez pode demorar)...';
                    ocrWorker = await Tesseract.createWorker({
                        logger: m => {
                            if (m.status === 'loading tesseract core') {
                                ocrLoadingText.textContent = 'Carregando n√∫cleo do Tesseract...';
                            } else if (m.status === 'loading language traineddata') {
                                ocrLoadingText.textContent = `Carregando dados de idioma (${currentLanguage})...`; 
                            } else if (m.status === 'recognizing text') {
                                const progress = Math.round(m.progress * 100);
                                ocrLoadingText.textContent = `Extraindo texto... ${progress}%`;
                            } else if (m.status === 'initialized') {
                                ocrLoadingText.textContent = 'Engine OCR pronta!';
                            }
                        }
                    });
                    isWorkerInitializing = false;
                }

                const tesseractLang = 'eng'; 
                ocrLoadingText.textContent = `Carregando modelo de ${tesseractLang}...`;
                await ocrWorker.loadLanguage(tesseractLang);
                await ocrWorker.initialize(tesseractLang);

                const ocrParams = {
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY,
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_LINE,
                    tessedit_char_whitelist: '0123456789'
                };
                await ocrWorker.setParameters(ocrParams);

                ocrLoadingText.textContent = 'Analisando imagem e extraindo texto...';
                const startTime = Date.now();
                const { data: { text, confidence } } = await ocrWorker.recognize(currentImageFile);
                const endTime = Date.now();
                const processingTime = endTime - startTime;
                
                hideOcrLoading();
                ocrProcessBtn.disabled = false;

                if (text) {
                    let cleanText = text.replace(/[^0-9]/g, '');
                    const incorrectPattern = '2063';
                    const correctPattern = '2963';
                    if (cleanText.includes(incorrectPattern)) {
                        cleanText = cleanText.replaceAll(incorrectPattern, correctPattern);
                        console.warn(`Corre√ß√£o heur√≠stica aplicada: todas as ocorr√™ncias de '${incorrectPattern}' alteradas para '${correctPattern}'.`);
                    }
                    
                    const confidencePercent = Math.round(confidence);
                    const charCount = cleanText.length;
                    
                    let resultHtml = '<div class="success-state">‚úÖ Texto extra√≠do com sucesso!</div>';
                    if (confidencePercent < 70) {
                        resultHtml += '<div class="warning-state">‚ö†Ô∏è Confian√ßa baixa - verifique o resultado</div>';
                    }
                    resultHtml += cleanText;
                    resultHtml += `<div class="character-count-info">Caracteres: ${charCount}</div>`;
                    
                    ocrTextResult.innerHTML = resultHtml;
                    copyOcrBtn.disabled = false;
                    
                    ocrUsageInfo.style.display = 'block';
                    ocrUsageText.innerHTML = `Processado em ${(processingTime/1000).toFixed(1)}s ‚Ä¢ Confian√ßa: ${confidencePercent}%`;
                    
                } else {
                    ocrTextResult.innerHTML = '<div class="warning-state">‚ö†Ô∏è Nenhum texto encontrado na imagem</div><br>Tente com:<br>‚Ä¢ Imagem com melhor qualidade<br>‚Ä¢ Maior contraste entre texto e fundo<br>‚Ä¢ Texto mais n√≠tido<br>‚Ä¢ Rotacionar a imagem se necess√°rio';
                }

            } catch (error) {
                hideOcrLoading();
                ocrProcessBtn.disabled = false;
                console.error('Erro no OCR:', error);
                let errorMessage = '‚ùå Erro no processamento OCR';
                if (error.message?.includes('language')) {
                    errorMessage += '\n\n‚Ä¢ Erro ao carregar modelo de idioma\n‚Ä¢ Tente novamente ou escolha outro idioma';
                } else if (error.message?.includes('worker') || error.message?.includes('terminated')) {
                    errorMessage += '\n\n‚Ä¢ Reinicializando engine OCR...<br>‚Ä¢ Tente novamente';
                    ocrWorker = null;
                } else {
                    errorMessage += '\n\n' + error.message;
                }
                ocrTextResult.innerHTML = `<div class="error-state">${errorMessage}</div>`;
            } finally {
                ocrFileInput.value = '';
            }
        }

        function copyOcrText() {
            const text = ocrTextResult.textContent;
            const cleanText = text.replace(/‚úÖ.*?\n/, '').replace(/‚ö†Ô∏è.*?\n/, '').replace(/Caracteres: \d+/, '');
            
            if (cleanText && cleanText.length > 0) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(cleanText).then(() => {
                        showCopyFeedback(copyOcrBtn);
                    }).catch(err => {
                        console.error('Falha ao copiar (Clipboard API):', err);
                        fallbackCopyTextToClipboard(cleanText, copyOcrBtn);
                    });
                } else {
                    fallbackCopyTextToClipboard(cleanText, copyOcrBtn);
                }
            } else {
                ocrTextResult.innerHTML = '<div class="warning-state">Nenhum texto para copiar!</div>';
            }
        }

        // --- Fun√ß√µes do Limpador de C√≥digo de Barras ---
        function cleanBarcode() {
            const rawBarcode = barcodeInput.value;
            const cleaned = rawBarcode.replace(/[ \-.,]/g, ''); 
            
            if (cleaned.length > 0) {
                cleanedBarcodeResult.innerHTML = `<div class="success-state">‚úÖ C√≥digo limpo com sucesso!</div>${cleaned}`;
                copyBarcodeBtn.disabled = false;
            } else {
                cleanedBarcodeResult.innerHTML = '<div class="warning-state">‚ö†Ô∏è Nenhum n√∫mero v√°lido encontrado.</div>';
                copyBarcodeBtn.disabled = true;
            }
        }

        function copyBarcode() {
            const text = cleanedBarcodeResult.textContent;
            const cleanText = text.replace(/‚úÖ C√≥digo limpo com sucesso!/, '').trim();
            
            if (cleanText && cleanText.length > 0) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(cleanText).then(() => {
                        showCopyFeedback(copyBarcodeBtn);
                    }).catch(err => {
                        console.error('Falha ao copiar (Clipboard API):', err);
                        fallbackCopyTextToClipboard(cleanText, copyBarcodeBtn);
                    });
                } else {
                    fallbackCopyTextToClipboard(cleanText, copyBarcodeBtn);
                }
            } else {
                cleanedBarcodeResult.innerHTML = '<div class="warning-state">Nenhum texto para copiar!</div>';
            }
        }

        // --- Fun√ß√µes de Utilit√°rio Compartilhadas ---
        function showCopyFeedback(buttonElement) {
            const originalText = buttonElement.textContent;
            buttonElement.textContent = '‚úÖ Copiado!';
            buttonElement.style.background = 'linear-gradient(45deg, #4CAF50, #2E7D32)'; /* Verde para feedback de c√≥pia */
            
            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.style.background = 'linear-gradient(45deg, #ED1C24, #C00000)'; /* Retorna ao vermelho original */
            }, 2000);
        }

        function fallbackCopyTextToClipboard(text, buttonElement) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.opacity = "0";
            textArea.style.pointerEvents = "none";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showCopyFeedback(buttonElement);
                } else {
                    console.error('Falha ao copiar (execCommand)');
                    if (buttonElement.id === 'copyOcrBtn') {
                        ocrTextResult.innerHTML = '<div class="error-state">Erro ao copiar texto. Por favor, copie manualmente.</div>';
                    } else if (buttonElement.id === 'copyBarcodeBtn') {
                        cleanedBarcodeResult.innerHTML = '<div class="error-state">Erro ao copiar texto. Por favor, copie manualmente.</div>';
                    }
                }
            } catch (err) {
                console.error('Falha ao copiar (execCommand):', err);
                if (buttonElement.id === 'copyOcrBtn') {
                    ocrTextResult.innerHTML = '<div class="error-state">Erro ao copiar texto. Por favor, copie manualmente.</div>';
                } else if (buttonElement.id === 'copyBarcodeBtn') {
                    cleanedBarcodeResult.innerHTML = '<div class="error-state">Erro ao copiar texto. Por favor, copie manualmente.</div>';
                }
            }
            document.body.removeChild(textArea);
        }

        // Limpar worker Tesseract quando a p√°gina for fechada
        window.addEventListener('beforeunload', async function() {
            if (ocrWorker) {
                try {
                    await ocrWorker.terminate();
                    console.log('Tesseract worker terminado.');
                } catch (e) {
                    console.warn('Erro ao terminar worker Tesseract (pode j√° ter sido terminado):', e);
                }
            }
        });
    </script>
</body>
</html>